{
  "omopTable": "Observation",
  "origin": "COSD",
  "omopColumns": [
    {
      "name": "nhs_number",
      "operation_description": "Value copied from `NhsNumber`",
      "dataSource": [
        {
          "name": "NhsNumber",
          "description": "Patient NHS Number",
          "origins": [
            {
              "origin": "NHS NUMBER",
              "url": null
            }
          ]
        }
      ],
      "query": "\n;with \n\tXMLNAMESPACES('http://www.datadictionary.nhs.uk/messages/COSD-v8-1' AS COSD81),\n\tCosdRecords as ( \n\n\tselect\n\t\tT.staging.value('(Id/@root)[1]', 'uniqueidentifier') as Id,\n\t\tT.staging.query('.') as Node\n\tfrom omop_staging.cosd_staging\n\tcross apply content.nodes('COSD81:COSD/*') as T(staging)\n\twhere T.staging.exist('Id/@root') = 1\n\t\tand Content.value('namespace-uri((/*:COSD)[1])','nvarchar(max)') = 'http://www.datadictionary.nhs.uk/messages/COSD-v8-1'\n\t\tand substring (FileName, 15, 2) = 'CO'\n), CO as (\n\tselect\n\t\tId,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/DateFirstSeen)[1]', 'varchar(max)') as DateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/SpecialistDateFirstSeen)[1]', 'varchar(max)') as SpecialistDateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkageDiagnosticDetails/ClinicalDateCancerDiagnosis)[1]', 'varchar(max)') as ClinicalDateCancerDiagnosis,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/IntegratedStageTNMStageGroupingDate)[1]', 'varchar(max)') as IntegratedStageTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/FinalPreTreatmentTNMStageGroupingDate)[1]', 'varchar(max)') as FinalPreTreatmentTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/CancerTreatmentStartDate)[1]', 'varchar(max)') as CancerTreatmentStartDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/ColorectalCoreSurgeryAndOtherProcedures/ProcedureDate)[1]', 'varchar(max)') as ProcedureDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreNonPrimaryCancerPathway/SourceOfReferralForOutPatientsNonPrimaryCancerPathway/@code)[1]', 'varchar(max)') as SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkagePatientId/NHSNumber/@extension)[1]', 'varchar(max)') as NhsNumber\n  from CosdRecords\n)\nselect\n      distinct\n          SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n          NhsNumber,\n          (\n              select\n                  min (i) as [Date]\n              from\n              (\n                values\n                (DateFirstSeen),\n                (SpecialistDateFirstSeen),\n                (ClinicalDateCancerDiagnosis),\n                (IntegratedStageTNMStageGroupingDate),\n                (FinalPreTreatmentTNMStageGroupingDate),\n                (CancerTreatmentStartDate),\n                (ProcedureDate)\n              ) as T(i)\n          ) as [Date]\nfrom CO o\nwhere o.SourceOfReferralForOutPatientsNonPrimaryCancerPathway is not null\n  and not (\n\t\tDateFirstSeen is null and\n\t\tSpecialistDateFirstSeen is null and\n\t\tClinicalDateCancerDiagnosis is null and\n\t\tIntegratedStageTNMStageGroupingDate is null and\n\t\tFinalPreTreatmentTNMStageGroupingDate is null and\n\t\tCancerTreatmentStartDate is null and\n\t\tProcedureDate is null\n)\n    ",
      "lookup_table_markdown": null
    },
    {
      "name": "observation_concept_id",
      "operation_description": "Constant value set to `4258129`. Referral by",
      "dataSource": null,
      "query": null,
      "lookup_table_markdown": null
    },
    {
      "name": "observation_date",
      "operation_description": "Converts text to dates.",
      "dataSource": [
        {
          "name": "Date",
          "description": "Observation date",
          "origins": [
            {
              "origin": "DATE FIRST SEEN",
              "url": null
            },
            {
              "origin": "DATE FIRST SEEN (CANCER SPECIALIST)",
              "url": null
            },
            {
              "origin": "DIAGNOSIS DATE",
              "url": null
            },
            {
              "origin": "TNM STAGE GROUPING DATE (INTEGRATED)",
              "url": null
            },
            {
              "origin": "TNM STAGE GROUPING DATE (FINAL PRETREATMENT)",
              "url": null
            },
            {
              "origin": "TREATMENT START DATE (CANCER)",
              "url": null
            },
            {
              "origin": "PROCEDURE DATE",
              "url": null
            }
          ]
        }
      ],
      "query": "\n;with \n\tXMLNAMESPACES('http://www.datadictionary.nhs.uk/messages/COSD-v8-1' AS COSD81),\n\tCosdRecords as ( \n\n\tselect\n\t\tT.staging.value('(Id/@root)[1]', 'uniqueidentifier') as Id,\n\t\tT.staging.query('.') as Node\n\tfrom omop_staging.cosd_staging\n\tcross apply content.nodes('COSD81:COSD/*') as T(staging)\n\twhere T.staging.exist('Id/@root') = 1\n\t\tand Content.value('namespace-uri((/*:COSD)[1])','nvarchar(max)') = 'http://www.datadictionary.nhs.uk/messages/COSD-v8-1'\n\t\tand substring (FileName, 15, 2) = 'CO'\n), CO as (\n\tselect\n\t\tId,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/DateFirstSeen)[1]', 'varchar(max)') as DateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/SpecialistDateFirstSeen)[1]', 'varchar(max)') as SpecialistDateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkageDiagnosticDetails/ClinicalDateCancerDiagnosis)[1]', 'varchar(max)') as ClinicalDateCancerDiagnosis,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/IntegratedStageTNMStageGroupingDate)[1]', 'varchar(max)') as IntegratedStageTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/FinalPreTreatmentTNMStageGroupingDate)[1]', 'varchar(max)') as FinalPreTreatmentTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/CancerTreatmentStartDate)[1]', 'varchar(max)') as CancerTreatmentStartDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/ColorectalCoreSurgeryAndOtherProcedures/ProcedureDate)[1]', 'varchar(max)') as ProcedureDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreNonPrimaryCancerPathway/SourceOfReferralForOutPatientsNonPrimaryCancerPathway/@code)[1]', 'varchar(max)') as SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkagePatientId/NHSNumber/@extension)[1]', 'varchar(max)') as NhsNumber\n  from CosdRecords\n)\nselect\n      distinct\n          SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n          NhsNumber,\n          (\n              select\n                  min (i) as [Date]\n              from\n              (\n                values\n                (DateFirstSeen),\n                (SpecialistDateFirstSeen),\n                (ClinicalDateCancerDiagnosis),\n                (IntegratedStageTNMStageGroupingDate),\n                (FinalPreTreatmentTNMStageGroupingDate),\n                (CancerTreatmentStartDate),\n                (ProcedureDate)\n              ) as T(i)\n          ) as [Date]\nfrom CO o\nwhere o.SourceOfReferralForOutPatientsNonPrimaryCancerPathway is not null\n  and not (\n\t\tDateFirstSeen is null and\n\t\tSpecialistDateFirstSeen is null and\n\t\tClinicalDateCancerDiagnosis is null and\n\t\tIntegratedStageTNMStageGroupingDate is null and\n\t\tFinalPreTreatmentTNMStageGroupingDate is null and\n\t\tCancerTreatmentStartDate is null and\n\t\tProcedureDate is null\n)\n    ",
      "lookup_table_markdown": null
    },
    {
      "name": "observation_datetime",
      "operation_description": "Converts text to dates.",
      "dataSource": [
        {
          "name": "Date",
          "description": "Observation date",
          "origins": [
            {
              "origin": "DATE FIRST SEEN",
              "url": null
            },
            {
              "origin": "DATE FIRST SEEN (CANCER SPECIALIST)",
              "url": null
            },
            {
              "origin": "DIAGNOSIS DATE",
              "url": null
            },
            {
              "origin": "TNM STAGE GROUPING DATE (INTEGRATED)",
              "url": null
            },
            {
              "origin": "TNM STAGE GROUPING DATE (FINAL PRETREATMENT)",
              "url": null
            },
            {
              "origin": "TREATMENT START DATE (CANCER)",
              "url": null
            },
            {
              "origin": "PROCEDURE DATE",
              "url": null
            }
          ]
        }
      ],
      "query": "\n;with \n\tXMLNAMESPACES('http://www.datadictionary.nhs.uk/messages/COSD-v8-1' AS COSD81),\n\tCosdRecords as ( \n\n\tselect\n\t\tT.staging.value('(Id/@root)[1]', 'uniqueidentifier') as Id,\n\t\tT.staging.query('.') as Node\n\tfrom omop_staging.cosd_staging\n\tcross apply content.nodes('COSD81:COSD/*') as T(staging)\n\twhere T.staging.exist('Id/@root') = 1\n\t\tand Content.value('namespace-uri((/*:COSD)[1])','nvarchar(max)') = 'http://www.datadictionary.nhs.uk/messages/COSD-v8-1'\n\t\tand substring (FileName, 15, 2) = 'CO'\n), CO as (\n\tselect\n\t\tId,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/DateFirstSeen)[1]', 'varchar(max)') as DateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/SpecialistDateFirstSeen)[1]', 'varchar(max)') as SpecialistDateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkageDiagnosticDetails/ClinicalDateCancerDiagnosis)[1]', 'varchar(max)') as ClinicalDateCancerDiagnosis,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/IntegratedStageTNMStageGroupingDate)[1]', 'varchar(max)') as IntegratedStageTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/FinalPreTreatmentTNMStageGroupingDate)[1]', 'varchar(max)') as FinalPreTreatmentTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/CancerTreatmentStartDate)[1]', 'varchar(max)') as CancerTreatmentStartDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/ColorectalCoreSurgeryAndOtherProcedures/ProcedureDate)[1]', 'varchar(max)') as ProcedureDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreNonPrimaryCancerPathway/SourceOfReferralForOutPatientsNonPrimaryCancerPathway/@code)[1]', 'varchar(max)') as SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkagePatientId/NHSNumber/@extension)[1]', 'varchar(max)') as NhsNumber\n  from CosdRecords\n)\nselect\n      distinct\n          SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n          NhsNumber,\n          (\n              select\n                  min (i) as [Date]\n              from\n              (\n                values\n                (DateFirstSeen),\n                (SpecialistDateFirstSeen),\n                (ClinicalDateCancerDiagnosis),\n                (IntegratedStageTNMStageGroupingDate),\n                (FinalPreTreatmentTNMStageGroupingDate),\n                (CancerTreatmentStartDate),\n                (ProcedureDate)\n              ) as T(i)\n          ) as [Date]\nfrom CO o\nwhere o.SourceOfReferralForOutPatientsNonPrimaryCancerPathway is not null\n  and not (\n\t\tDateFirstSeen is null and\n\t\tSpecialistDateFirstSeen is null and\n\t\tClinicalDateCancerDiagnosis is null and\n\t\tIntegratedStageTNMStageGroupingDate is null and\n\t\tFinalPreTreatmentTNMStageGroupingDate is null and\n\t\tCancerTreatmentStartDate is null and\n\t\tProcedureDate is null\n)\n    ",
      "lookup_table_markdown": null
    },
    {
      "name": "observation_type_concept_id",
      "operation_description": "Constant value set to `32828`. `EHR episode record`",
      "dataSource": null,
      "query": null,
      "lookup_table_markdown": null
    },
    {
      "name": "value_as_string",
      "operation_description": "Value copied from `SourceOfReferralForOutPatientsNonPrimaryCancerPathway`",
      "dataSource": [
        {
          "name": "SourceOfReferralForOutPatientsNonPrimaryCancerPathway",
          "description": "SOURCE OF REFERRAL FOR OUT-PATIENTS (NON PRIMARY CANCER PATHWAY) identifies the source of referral for a Non Primary Cancer Pathway.",
          "origins": [
            {
              "origin": "SOURCE OF REFERRAL FOR OUT-PATIENTS (NON PRIMARY CANCER PATHWAY)",
              "url": null
            }
          ]
        }
      ],
      "query": "\n;with \n\tXMLNAMESPACES('http://www.datadictionary.nhs.uk/messages/COSD-v8-1' AS COSD81),\n\tCosdRecords as ( \n\n\tselect\n\t\tT.staging.value('(Id/@root)[1]', 'uniqueidentifier') as Id,\n\t\tT.staging.query('.') as Node\n\tfrom omop_staging.cosd_staging\n\tcross apply content.nodes('COSD81:COSD/*') as T(staging)\n\twhere T.staging.exist('Id/@root') = 1\n\t\tand Content.value('namespace-uri((/*:COSD)[1])','nvarchar(max)') = 'http://www.datadictionary.nhs.uk/messages/COSD-v8-1'\n\t\tand substring (FileName, 15, 2) = 'CO'\n), CO as (\n\tselect\n\t\tId,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/DateFirstSeen)[1]', 'varchar(max)') as DateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreReferralAndFirstStageOfPatientPathway/SpecialistDateFirstSeen)[1]', 'varchar(max)') as SpecialistDateFirstSeen,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkageDiagnosticDetails/ClinicalDateCancerDiagnosis)[1]', 'varchar(max)') as ClinicalDateCancerDiagnosis,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/IntegratedStageTNMStageGroupingDate)[1]', 'varchar(max)') as IntegratedStageTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreStaging/FinalPreTreatmentTNMStageGroupingDate)[1]', 'varchar(max)') as FinalPreTreatmentTNMStageGroupingDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/CancerTreatmentStartDate)[1]', 'varchar(max)') as CancerTreatmentStartDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreTreatment/ColorectalCoreSurgeryAndOtherProcedures/ProcedureDate)[1]', 'varchar(max)') as ProcedureDate,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreNonPrimaryCancerPathway/SourceOfReferralForOutPatientsNonPrimaryCancerPathway/@code)[1]', 'varchar(max)') as SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n\t\tNode.value('(COSDRecord/Colorectal/ColorectalCore/ColorectalCoreLinkagePatientId/NHSNumber/@extension)[1]', 'varchar(max)') as NhsNumber\n  from CosdRecords\n)\nselect\n      distinct\n          SourceOfReferralForOutPatientsNonPrimaryCancerPathway,\n          NhsNumber,\n          (\n              select\n                  min (i) as [Date]\n              from\n              (\n                values\n                (DateFirstSeen),\n                (SpecialistDateFirstSeen),\n                (ClinicalDateCancerDiagnosis),\n                (IntegratedStageTNMStageGroupingDate),\n                (FinalPreTreatmentTNMStageGroupingDate),\n                (CancerTreatmentStartDate),\n                (ProcedureDate)\n              ) as T(i)\n          ) as [Date]\nfrom CO o\nwhere o.SourceOfReferralForOutPatientsNonPrimaryCancerPathway is not null\n  and not (\n\t\tDateFirstSeen is null and\n\t\tSpecialistDateFirstSeen is null and\n\t\tClinicalDateCancerDiagnosis is null and\n\t\tIntegratedStageTNMStageGroupingDate is null and\n\t\tFinalPreTreatmentTNMStageGroupingDate is null and\n\t\tCancerTreatmentStartDate is null and\n\t\tProcedureDate is null\n)\n    ",
      "lookup_table_markdown": null
    }
  ]
}
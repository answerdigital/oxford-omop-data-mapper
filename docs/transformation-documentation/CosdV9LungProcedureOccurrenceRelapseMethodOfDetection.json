{
  "omopTable": "ProcedureOccurrence",
  "origin": "COSD",
  "omopColumns": [
    {
      "name": "nhs_number",
      "operation_description": "Value copied from `NhsNumber`",
      "dataSource": [
        {
          "name": "NhsNumber",
          "description": "Patient NHS Number",
          "origins": [
            {
              "origin": "NHS NUMBER",
              "url": "https://www.datadictionary.nhs.uk/data_elements/nhs_number.html"
            }
          ]
        }
      ],
      "query": "\nwith LU as (\n    select\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeen' as DateFirstSeen,\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeenCancerSpecialist' as DateFirstSeenCancerSpecialist,\n        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed' as DateOfPrimaryDiagnosisClinicallyAgreed,\n        Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage' as StageDateFinalPretreatmentStage,\n        Record ->> '$.PrimaryPathway.Staging.StageDateIntegratedStage' as StageDateIntegratedStage,\n        Record ->> '$.Treatment.TreatmentStartDateCancer' as TreatmentStartDateCancer,\n        Record ->> '$.Treatment.Surgery.ProcedureDate' as ProcedureDate,\n        unnest ([[Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection.@code'], Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection[*].@code'], recursive := true) as RelapseMethodOfDetection,\n        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber\n    from omop_staging.cosd_staging_901\n    where type = 'LU'\n)\nselect\n    distinct\n        RelapseMethodOfDetection,\n        NhsNumber,\n        least(\n            cast(DateFirstSeen as date),\n            cast(DateFirstSeenCancerSpecialist as date),\n            cast(DateOfPrimaryDiagnosisClinicallyAgreed as date),\n            cast(StageDateFinalPretreatmentStage as date),\n            cast(StageDateIntegratedStage as date),\n            cast(TreatmentStartDateCancer as date),\n            cast(ProcedureDate as date)\n        ) as Date\nfrom LU o\nwhere o.RelapseMethodOfDetection is not null\n  and not (\n        DateFirstSeen is null and\n        DateFirstSeenCancerSpecialist is null and\n        DateOfPrimaryDiagnosisClinicallyAgreed is null and\n        StageDateFinalPretreatmentStage is null and\n        StageDateIntegratedStage is null and\n        TreatmentStartDateCancer is null and\n        ProcedureDate is null\n    )\n    ",
      "lookup_table_markdown": null
    },
    {
      "name": "procedure_concept_id",
      "operation_description": "Lookup RelapseMethodOfDetection concepts for lung cancer recurrence.",
      "dataSource": [
        {
          "name": "RelapseMethodOfDetection",
          "description": "A code representing the method used to detect a relapse or recurrence.",
          "origins": [
            {
              "origin": "RELAPSE - METHOD OF DETECTION",
              "url": null
            }
          ]
        }
      ],
      "query": "\nwith LU as (\n    select\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeen' as DateFirstSeen,\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeenCancerSpecialist' as DateFirstSeenCancerSpecialist,\n        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed' as DateOfPrimaryDiagnosisClinicallyAgreed,\n        Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage' as StageDateFinalPretreatmentStage,\n        Record ->> '$.PrimaryPathway.Staging.StageDateIntegratedStage' as StageDateIntegratedStage,\n        Record ->> '$.Treatment.TreatmentStartDateCancer' as TreatmentStartDateCancer,\n        Record ->> '$.Treatment.Surgery.ProcedureDate' as ProcedureDate,\n        unnest ([[Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection.@code'], Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection[*].@code'], recursive := true) as RelapseMethodOfDetection,\n        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber\n    from omop_staging.cosd_staging_901\n    where type = 'LU'\n)\nselect\n    distinct\n        RelapseMethodOfDetection,\n        NhsNumber,\n        least(\n            cast(DateFirstSeen as date),\n            cast(DateFirstSeenCancerSpecialist as date),\n            cast(DateOfPrimaryDiagnosisClinicallyAgreed as date),\n            cast(StageDateFinalPretreatmentStage as date),\n            cast(StageDateIntegratedStage as date),\n            cast(TreatmentStartDateCancer as date),\n            cast(ProcedureDate as date)\n        ) as Date\nfrom LU o\nwhere o.RelapseMethodOfDetection is not null\n  and not (\n        DateFirstSeen is null and\n        DateFirstSeenCancerSpecialist is null and\n        DateOfPrimaryDiagnosisClinicallyAgreed is null and\n        StageDateFinalPretreatmentStage is null and\n        StageDateIntegratedStage is null and\n        TreatmentStartDateCancer is null and\n        ProcedureDate is null\n    )\n    ",
      "lookup_table_markdown": "\r\n\r\n|RelapseMethodOfDetection|procedure_concept_id|notes|\r\n|------|-----|-----|\r\n|1|4303062|Morphology|\r\n|2|4276031|Flow|\r\n|3|4233623|Molecular|\r\n|4|4240345|Clinical Examination|\r\n|9|0|Other (not listed)|\r\n\r\nNotes\r\n* [OMOP Morphology](https://athena.ohdsi.org/search-terms/terms/4303062)\r\n* [OMOP Flow](https://athena.ohdsi.org/search-terms/terms/4276031)\r\n* [OMOP Molecular](https://athena.ohdsi.org/search-terms/terms/4233623)\r\n* [OMOP Clinical Examination](https://athena.ohdsi.org/search-terms/terms/4240345)\r\n* [RELAPSE - METHOD OF DETECTION](https://www.datadictionary.nhs.uk/data_elements/relapse_-_method_of_detection.html)\r\n"
    },
    {
      "name": "procedure_date",
      "operation_description": "Value copied from `Date`",
      "dataSource": [
        {
          "name": "Date",
          "description": "Procedure date",
          "origins": [
            {
              "origin": "CANCER RECURRENCE OR PROGRESSION - DATE DETECTED",
              "url": null
            }
          ]
        }
      ],
      "query": "\nwith LU as (\n    select\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeen' as DateFirstSeen,\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeenCancerSpecialist' as DateFirstSeenCancerSpecialist,\n        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed' as DateOfPrimaryDiagnosisClinicallyAgreed,\n        Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage' as StageDateFinalPretreatmentStage,\n        Record ->> '$.PrimaryPathway.Staging.StageDateIntegratedStage' as StageDateIntegratedStage,\n        Record ->> '$.Treatment.TreatmentStartDateCancer' as TreatmentStartDateCancer,\n        Record ->> '$.Treatment.Surgery.ProcedureDate' as ProcedureDate,\n        unnest ([[Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection.@code'], Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection[*].@code'], recursive := true) as RelapseMethodOfDetection,\n        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber\n    from omop_staging.cosd_staging_901\n    where type = 'LU'\n)\nselect\n    distinct\n        RelapseMethodOfDetection,\n        NhsNumber,\n        least(\n            cast(DateFirstSeen as date),\n            cast(DateFirstSeenCancerSpecialist as date),\n            cast(DateOfPrimaryDiagnosisClinicallyAgreed as date),\n            cast(StageDateFinalPretreatmentStage as date),\n            cast(StageDateIntegratedStage as date),\n            cast(TreatmentStartDateCancer as date),\n            cast(ProcedureDate as date)\n        ) as Date\nfrom LU o\nwhere o.RelapseMethodOfDetection is not null\n  and not (\n        DateFirstSeen is null and\n        DateFirstSeenCancerSpecialist is null and\n        DateOfPrimaryDiagnosisClinicallyAgreed is null and\n        StageDateFinalPretreatmentStage is null and\n        StageDateIntegratedStage is null and\n        TreatmentStartDateCancer is null and\n        ProcedureDate is null\n    )\n    ",
      "lookup_table_markdown": null
    },
    {
      "name": "procedure_datetime",
      "operation_description": "Value copied from `Date`",
      "dataSource": [
        {
          "name": "Date",
          "description": "Procedure date",
          "origins": [
            {
              "origin": "CANCER RECURRENCE OR PROGRESSION - DATE DETECTED",
              "url": null
            }
          ]
        }
      ],
      "query": "\nwith LU as (\n    select\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeen' as DateFirstSeen,\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeenCancerSpecialist' as DateFirstSeenCancerSpecialist,\n        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed' as DateOfPrimaryDiagnosisClinicallyAgreed,\n        Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage' as StageDateFinalPretreatmentStage,\n        Record ->> '$.PrimaryPathway.Staging.StageDateIntegratedStage' as StageDateIntegratedStage,\n        Record ->> '$.Treatment.TreatmentStartDateCancer' as TreatmentStartDateCancer,\n        Record ->> '$.Treatment.Surgery.ProcedureDate' as ProcedureDate,\n        unnest ([[Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection.@code'], Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection[*].@code'], recursive := true) as RelapseMethodOfDetection,\n        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber\n    from omop_staging.cosd_staging_901\n    where type = 'LU'\n)\nselect\n    distinct\n        RelapseMethodOfDetection,\n        NhsNumber,\n        least(\n            cast(DateFirstSeen as date),\n            cast(DateFirstSeenCancerSpecialist as date),\n            cast(DateOfPrimaryDiagnosisClinicallyAgreed as date),\n            cast(StageDateFinalPretreatmentStage as date),\n            cast(StageDateIntegratedStage as date),\n            cast(TreatmentStartDateCancer as date),\n            cast(ProcedureDate as date)\n        ) as Date\nfrom LU o\nwhere o.RelapseMethodOfDetection is not null\n  and not (\n        DateFirstSeen is null and\n        DateFirstSeenCancerSpecialist is null and\n        DateOfPrimaryDiagnosisClinicallyAgreed is null and\n        StageDateFinalPretreatmentStage is null and\n        StageDateIntegratedStage is null and\n        TreatmentStartDateCancer is null and\n        ProcedureDate is null\n    )\n    ",
      "lookup_table_markdown": null
    },
    {
      "name": "procedure_type_concept_id",
      "operation_description": "Constant value set to `32828`. `EHR episode record`",
      "dataSource": null,
      "query": null,
      "lookup_table_markdown": null
    },
    {
      "name": "procedure_source_value",
      "operation_description": "Value copied from `RelapseMethodOfDetection`",
      "dataSource": [
        {
          "name": "RelapseMethodOfDetection",
          "description": "A code representing the method used to detect a relapse or recurrence.",
          "origins": [
            {
              "origin": "RELAPSE - METHOD OF DETECTION",
              "url": null
            }
          ]
        }
      ],
      "query": "\nwith LU as (\n    select\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeen' as DateFirstSeen,\n        Record ->> '$.PrimaryPathway.ReferralAndFirstStageOfPatientPathway.DateFirstSeenCancerSpecialist' as DateFirstSeenCancerSpecialist,\n        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed' as DateOfPrimaryDiagnosisClinicallyAgreed,\n        Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage' as StageDateFinalPretreatmentStage,\n        Record ->> '$.PrimaryPathway.Staging.StageDateIntegratedStage' as StageDateIntegratedStage,\n        Record ->> '$.Treatment.TreatmentStartDateCancer' as TreatmentStartDateCancer,\n        Record ->> '$.Treatment.Surgery.ProcedureDate' as ProcedureDate,\n        unnest ([[Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection.@code'], Record ->> '$.NonPrimaryPathway.Recurrence.Relapse-MethodOfDetection[*].@code'], recursive := true) as RelapseMethodOfDetection,\n        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber\n    from omop_staging.cosd_staging_901\n    where type = 'LU'\n)\nselect\n    distinct\n        RelapseMethodOfDetection,\n        NhsNumber,\n        least(\n            cast(DateFirstSeen as date),\n            cast(DateFirstSeenCancerSpecialist as date),\n            cast(DateOfPrimaryDiagnosisClinicallyAgreed as date),\n            cast(StageDateFinalPretreatmentStage as date),\n            cast(StageDateIntegratedStage as date),\n            cast(TreatmentStartDateCancer as date),\n            cast(ProcedureDate as date)\n        ) as Date\nfrom LU o\nwhere o.RelapseMethodOfDetection is not null\n  and not (\n        DateFirstSeen is null and\n        DateFirstSeenCancerSpecialist is null and\n        DateOfPrimaryDiagnosisClinicallyAgreed is null and\n        StageDateFinalPretreatmentStage is null and\n        StageDateIntegratedStage is null and\n        TreatmentStartDateCancer is null and\n        ProcedureDate is null\n    )\n    ",
      "lookup_table_markdown": null
    }
  ]
}
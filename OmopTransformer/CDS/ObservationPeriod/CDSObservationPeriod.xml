<Query>
    <Sql>
;with PatientIdentifer as (
select
	nhs_number,
	cds_unique_identifier
from [standardised].[v_CDS_AccidentEmergency]
union
select
	d.nhs_number,
	d.cds_unique_identifier
from [standardised].[v_CDS_Inpatient_Demographics] d
	inner join [standardised].[v_CDS_Inpatient_ConsultantEpisode] ce
		on d.cds_unique_identifier = ce.cds_unique_identifier
), Episode as (
select
	(
		select 
			min(cdw_arrival_date_time) as cdw_arrival_date_time
		from [standardised].[v_CDS_AccidentEmergency] ae
		where ae.nhs_number = patientIdentifier.nhs_number
	) as EDArrival,
	(
		select 
			max(cdw_departure_date_time) as cdw_arrival_date_time
		from [standardised].[v_CDS_AccidentEmergency] ae
		where ae.nhs_number = patientIdentifier.nhs_number
	) as EDDeparture,
	(
		select 
			min(ce.start_date_episode) as start_date_episode
		from [standardised].[v_CDS_Inpatient_Demographics] id
			inner join [standardised].[v_CDS_Inpatient_ConsultantEpisode] ce
				on id.cds_unique_identifier = ce.cds_unique_identifier
		where id.nhs_number = patientIdentifier.nhs_number
	) as InpatientArrival,
	(
		select 
			max(ce.end_date_episode) as end_date_episode
		from [standardised].[v_CDS_Inpatient_Demographics] id
			inner join [standardised].[v_CDS_Inpatient_ConsultantEpisode] ce
				on id.cds_unique_identifier = ce.cds_unique_identifier
		where id.nhs_number = patientIdentifier.nhs_number
	) as InpatientDeparture,
	patientIdentifier.*
from PatientIdentifer patientIdentifier
)
select
	(select min(Date) from (values (e.EDArrival), (e.InpatientArrival)) as Dates(Date)) as observation_period_start_date,
	(select max(Date) from (values (e.EDDeparture), (e.InpatientDeparture)) as Dates(Date)) as observation_period_end_date,
	e.nhs_number
from Episode e;
    </Sql>
    <Explanation>
        <OmopColumnExplanation columName="observation_period_start_date">Is the earliest date using `v_CDS_AccidentEmergency.cdw_arrival_date_time` and `v_CDS_Inpatient_ConsultantEpisode.start_date_episode` records.</OmopColumnExplanation>
        <OmopColumnExplanation columName="observation_period_end_date">Is the most recent date using `v_CDS_AccidentEmergency.cdw_departure_date_time` and `v_CDS_Inpatient_ConsultantEpisode.end_date_episode` records.</OmopColumnExplanation>
    </Explanation>
</Query>
<Query>
    <Sql>
select 
  distinct
    Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber,
    coalesce(
        Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage',
        Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed'
    ) as MeasurementDate,
    Record ->> '$.PrimaryPathway.Staging.MCategoryFinalPretreatment' as McategoryFinalPreTreatment
from omop_staging.cosd_staging_901
where type = 'LU'
  and McategoryFinalPreTreatment is not null
  and NhsNumber is not null
	</Sql>
    <Explanations>
	    <Explanation columnName="NhsNumber">
		    <Description>Patient NHS Number</Description>
		    <Origin>NHS NUMBER</Origin>
	    </Explanation>
	    <Explanation columnName="MeasurementDate">
			<Description>The date of the staging measurement, using the stage date if available, otherwise the diagnosis date.</Description>
			<Origin>STAGE DATE FINAL PRETREATMENT STAGE / DATE OF PRIMARY CANCER DIAGNOSIS (CLINICALLY AGREED)</Origin>
		</Explanation>
		<Explanation columnName="McategoryFinalPreTreatment">
			<Description>The M category (distant metastasis) assigned to the tumour at the time of the final pre-treatment stage.</Description>
			<Origin>M CATEGORY FINAL PRETREATMENT</Origin>
		</Explanation>
	</Explanations>
</Query>

<Query>
    <Sql>
with lung as (
select 
    Record ->> '$.Lung.LungCore.LungCoreLinkagePatientId.NHSNumber.@extension' as NhsNumber,
    Record ->> '$.Lung.LungCore.LungCoreLinkageDiagnosticDetails.ClinicalDateCancerDiagnosis' as ClinicalDateCancerDiagnosis,
    unnest(
      [
        [
          Record ->> '$.Lung.LungCore.LungCoreDiagnosis.MetastaticSite.@code'
        ], 
        Record ->> '$.Lung.LungCore.LungCoreDiagnosis.MetastaticSite[*].@code'
      ], recursive := true
    ) as MetastaticSite
from omop_staging.cosd_staging_81
where Type = 'LU'
)
select distinct
    NhsNumber,
    ClinicalDateCancerDiagnosis,
    MetastaticSite
from lung
where MetastaticSite is not null
  and MetastaticSite != 97
  and NhsNumber is not null;

	</Sql>
    <Explanations>
	    <Explanation columnName="NhsNumber">
		    <Description>Patient NHS Number</Description>
		    <Origin>NHS NUMBER</Origin>
	    </Explanation>
	    <Explanation columnName="ClinicalDateCancerDiagnosis">
			<Description>The date on which the diagnosis of cancer was made or agreed clinically, excluding the basis of screening alone.</Description>
			<Origin>DATE OF PRIMARY CANCER DIAGNOSIS (CLINICALLY AGREED)</Origin>
		</Explanation>
		<Explanation columnName="MetastaticSite">
			<Description>A code that records the site(s) of metastatic disease at diagnosis.</Description>
			<Origin>METASTATIC SITE</Origin>
		</Explanation>
	</Explanations>
</Query>

<Query>
    <Sql>
with LU as (
    select 
        Record ->> '$.Lung.LungCore.LungCoreReferralAndFirstStageOfPatientPathway.DateFirstSeen' as DateFirstSeen,
        Record ->> '$.Lung.LungCore.LungCoreReferralAndFirstStageOfPatientPathway.SpecialistDateFirstSeen' as SpecialistDateFirstSeen,
        Record ->> '$.Lung.LungCore.LungCoreLinkageDiagnosticDetails.ClinicalDateCancerDiagnosis' as ClinicalDateCancerDiagnosis,
        Record ->> '$.Lung.LungCore.LungCoreStaging.IntegratedStageTNMStageGroupingDate' as IntegratedStageTNMStageGroupingDate,
        Record ->> '$.Lung.LungCore.LungCoreStaging.FinalPreTreatmentTNMStageGroupingDate' as FinalPreTreatmentTNMStageGroupingDate,
        coalesce(Record ->> '$.Lung.LungCore.LungCoreTreatment[0].CancerTreatmentStartDate', Record ->> '$.Lung.LungCore.LungCoreTreatment.CancerTreatmentStartDate') as CancerTreatmentStartDate,
        coalesce(Record ->> '$.Lung.LungCore.LungCoreTreatment[0].LungCoreSurgeryAndOtherProcedures.ProcedureDate', Record ->> '$.Lung.LungCore.LungCoreTreatment.LungCoreSurgeryAndOtherProcedures.ProcedureDate') as ProcedureDate,
        Record ->> '$.Lung.LungCore.LungCoreDiagnosis.AdultPerformanceStatus.@code' as AdultPerformanceStatus,
        Record ->> '$.Lung.LungCore.LungCoreLinkagePatientId.NHSNumber.@extension' as NhsNumber
    from omop_staging.cosd_staging_81
    where Type = 'LU'
)
select
      distinct
          AdultPerformanceStatus,
          NhsNumber,
          least(
                cast (DateFirstSeen as date),
                cast (SpecialistDateFirstSeen as date),
                cast (ClinicalDateCancerDiagnosis as date),
                cast (IntegratedStageTNMStageGroupingDate as date),
                cast (FinalPreTreatmentTNMStageGroupingDate as date),
                cast (CancerTreatmentStartDate as date),
                cast (ProcedureDate as date)
              ) as Date
from LU o
where o.AdultPerformanceStatus is not null
 and not (
    DateFirstSeen is null  and
    SpecialistDateFirstSeen is null  and
    ClinicalDateCancerDiagnosis is null  and
    IntegratedStageTNMStageGroupingDate is null  and
    FinalPreTreatmentTNMStageGroupingDate is null and
    CancerTreatmentStartDate is null and
    ProcedureDate is null 
  )
    </Sql>
    <Explanations>
      <Explanation columnName="NHSNumber">
    	  <Description>Patient NHS Number</Description>
    	  <Origin>NHS NUMBER</Origin>
      </Explanation>
		 <Explanation columnName="AdultPerformanceStatus">
		   <Description>A code from the Adult Performance Status Assessment Scale.</Description>
		   <Origin>PERFORMANCE STATUS (ADULT)</Origin>
		</Explanation>
      <Explanation columnName="Date" >
    	  <Description>Observation date</Description>
    	  <Origin>DATE FIRST SEEN</Origin>
    	  <Origin>DATE FIRST SEEN (CANCER SPECIALIST)</Origin>
    	  <Origin>DIAGNOSIS DATE</Origin>
    	  <Origin>TNM STAGE GROUPING DATE (INTEGRATED)</Origin>
    	  <Origin>TNM STAGE GROUPING DATE (FINAL PRETREATMENT)</Origin>
    	  <Origin>TREATMENT START DATE (CANCER)</Origin>
    	  <Origin>PROCEDURE DATE</Origin>
      </Explanation>
    </Explanations>
</Query>

<Query>
    <Sql>
		--fail
	    select distinct
    Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber,
    coalesce(
        cast(Record ->> '$.Treatment.DischargeDateHospitalProviderSpell' as date),
        make_date(
            cast(extract(year from cast(Record ->> '$.Treatment.TreatmentStartDateCancer' as date)) as integer),
            12,
            31
        )
    ) as DeathDate
from omop_staging.cosd_staging_901
where type = 'CO'
  and (Record ->> '$.Treatment.DischargeDestinationHospitalProviderSpell.@code') = '79';-- Not applicable - PATIENT died or stillbirth
	</Sql>
	<Explanations>
		<Explanation columnName="NhsNumber">
			<Description>Patient NHS Number</Description>
			<Origin>NHS NUMBER</Origin>
		</Explanation>
		
		<Explanation columnName="DeathDate">
			<Description>The date on which a PERSON died or is officially deemed to have died.</Description>
			<Origin>DISCHARGE DATE (HOSPITAL PROVIDER SPELL)</Origin>
			<Origin>TREATMENT START DATE (CANCER)</Origin>
		</Explanation>
	</Explanations>
</Query>
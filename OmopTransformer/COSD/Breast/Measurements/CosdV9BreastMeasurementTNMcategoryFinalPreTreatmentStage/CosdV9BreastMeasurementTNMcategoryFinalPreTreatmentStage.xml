<Query>
    <Sql>
with BR as (
    select 
        Record ->> '$.LinkagePatientId.NhsNumber.@extension' as NhsNumber,
        coalesce(
            Record ->> '$.PrimaryPathway.Staging.StageDateFinalPretreatmentStage',
            Record ->> '$.PrimaryPathway.LinkageDiagnosticDetails.DateOfPrimaryDiagnosisClinicallyAgreed'
        ) as MeasurementDate,
        Record ->> '$.PrimaryPathway.Staging.TnmStageGroupingFinalPretreatment' as TnmStageGroupingFinalPretreatment
    from omop_staging.cosd_staging_901
    where type = 'BR'
)
select distinct
    NhsNumber,
    MeasurementDate,
    TnmStageGroupingFinalPretreatment
from BR
where TnmStageGroupingFinalPretreatment is not null;
	</Sql>
    <Explanations>
	    <Explanation columnName="NHSNumber">
		    <Description>Patient NHS Number</Description>
		    <Origin>NHS NUMBER</Origin>
	    </Explanation>
	    <Explanation columnName="MeasurementDate">
			<Description>The date of the staging measurement, either the stage date or diagnosis date as fallback.</Description>
			<Origin>STAGE DATE FINAL PRETREATMENT STAGE / DATE OF PRIMARY CANCER DIAGNOSIS (CLINICALLY AGREED)</Origin>
		</Explanation>
		<Explanation columnName="TnmStageGroupingFinalPretreatment">
			<Description>The TNM stage grouping (combined T, N, M categories) of the final pre-treatment stage.</Description>
			<Origin>TNM STAGE GROUPING (FINAL PRETREATMENT)</Origin>
		</Explanation>
	</Explanations>
</Query>

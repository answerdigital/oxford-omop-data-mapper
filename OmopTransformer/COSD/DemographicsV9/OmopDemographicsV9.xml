<Query>
    <Sql>
with demographics as (
select 
  Record ->> '$..NhsNumber..@extension' ->> 0 as NhsNumber,
  Record ->> '$..PersonBirthDate' ->> 0 as DateOfBirth,
  Record ->> '$..StreetAddressLine[0].#cdata-section' ->> 0 as StreetAddressLine1,
  Record ->> '$..StreetAddressLine[1].#cdata-section' ->> 0 as StreetAddressLine2,
  Record ->> '$..StreetAddressLine[2].#cdata-section' ->> 0 as StreetAddressLine3,
  Record ->> '$..StreetAddressLine[3].#cdata-section' ->> 0 as StreetAddressLine4,
  Record ->> '$..PostcodeOfUsualAddressAtDiagnosis' ->> 0 as Postcode,
  Record ->> '$..EthnicCategory.@code' ->> 0 as EthnicCategory
from omop_staging.cosd_staging_901
)
select
	NhsNumber,
	max (DateOfBirth) as DateOfBirth,
	max (StreetAddressLine1) as StreetAddressLine1,
	max (StreetAddressLine2) as StreetAddressLine2,
	max (StreetAddressLine3) as StreetAddressLine3,
	max (StreetAddressLine4) as StreetAddressLine4,
	max (Postcode) as Postcode
from demographics 
where NhsNumber is not null
group by NhsNumber
	</Sql>
	<Explanations>
		<Explanation columnName="NhsNumber">
			<Description>Patient NHS Number</Description>
			<Origin>NHS NUMBER</Origin>
		</Explanation>
		
		<Explanation columnName="DateOfBirth">
			<Description>Patient's date of birth.</Description>
			<Origin>PERSON BIRTH DATE</Origin>
		</Explanation>

		<Explanation columnName="EthnicCategory">
			<Description>Patient EthnicCategory</Description>
			<Origin>ETHNIC CATEGORY</Origin>
		</Explanation>

		<Explanation columnName="StreetAddressLine1">
			<Description>The first line of the address.</Description>
			<Origin>PATIENT USUAL ADDRESS (AT DIAGNOSIS)</Origin>
		</Explanation>
		
		<Explanation columnName="StreetAddressLine2">
			<Description>The second line of the address.</Description>
			<Origin>PATIENT USUAL ADDRESS (AT DIAGNOSIS)</Origin>
		</Explanation>
		
		<Explanation columnName="StreetAddressLine3">
			<Description>The third line of the address.</Description>
			<Origin>PATIENT USUAL ADDRESS (AT DIAGNOSIS)</Origin>
		</Explanation>
		
		<Explanation columnName="StreetAddressLine4">
			<Description>The fourth line of the address.</Description>
			<Origin>PATIENT USUAL ADDRESS (AT DIAGNOSIS)</Origin>
		</Explanation>

		<Explanation columnName="Postcode">
			<Description>Patient Postcode</Description>
			<Origin>POSTCODE OF USUAL ADDRESS (AT DIAGNOSIS)</Origin>
		</Explanation>
	</Explanations>
</Query>
<Query>
    <Sql>
	select
		NHS_Number,
		CASE
            -- Check for yyyy-MM-dd format (contains dash and year first)
            WHEN max(Date_Of_Birth) LIKE '____-__-__' 
                THEN CAST(strptime(max(Date_Of_Birth), '%Y-%m-%d') AS TIMESTAMP)
            -- dd/MM/yyyy format, where day is between 1 and 31
            WHEN max(Date_Of_Birth) LIKE '__/__/____' AND CAST(substring(max(Date_Of_Birth), 1, 2) AS INTEGER) BETWEEN 1 AND 31
                THEN CAST(strptime(max(Date_Of_Birth), '%d/%m/%Y') AS TIMESTAMP)
            -- Otherwise assume MM/dd/yyyy format
            WHEN max(Date_Of_Birth) LIKE '__/__/____'
                THEN CAST(strptime(max(Date_Of_Birth), '%m/%d/%Y') AS TIMESTAMP)
            ELSE NULL
        END AS Date_Of_Birth,
		max (Person_Stated_Gender_Code) as Person_Stated_Gender_Code
	from omop_staging.sact_staging
	group by NHS_Number
	</Sql>
	<Explanations>
		<Explanation columnName="NHS_Number">
			<Description>Patient NHS Number</Description>
			<Origin>NHS NUMBER</Origin>
		</Explanation>
		<Explanation columnName="Date_Of_Birth">
			<Description>Patient's date of birth.</Description>
			<Origin>PERSON BIRTH DATE</Origin>
		</Explanation>
		<Explanation columnName="Person_Stated_Gender_Code">
			<Description>The patient's Sex</Description>
			<Origin>PERSON GENDER CODE CURRENT</Origin>
		</Explanation>
	</Explanations>
</Query>
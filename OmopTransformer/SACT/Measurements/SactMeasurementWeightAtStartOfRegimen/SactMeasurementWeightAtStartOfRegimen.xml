<Query>
    <Sql>
		select distinct 
			NHS_Number,
			Weight_At_Start_Of_Regimen,
			CASE
				-- Check for yyyy-MM-dd format (contains dash and year first)
				WHEN Start_Date_Of_Regimen LIKE '____-__-__' 
					THEN CAST(strptime(Start_Date_Of_Regimen, '%Y-%m-%d') AS DATE)
				-- Check for dd/MM/yyyy format (starts with day <= 31)
				WHEN Start_Date_Of_Regimen LIKE '__/__/____' AND CAST(substring(Start_Date_Of_Regimen, 1, 2) AS INTEGER) <= 31
					THEN CAST(strptime(Start_Date_Of_Regimen, '%d/%m/%Y') AS DATE)
				-- Otherwise assume MM/dd/yyyy format
				WHEN Start_Date_Of_Regimen LIKE '__/__/____'
					THEN CAST(strptime(Start_Date_Of_Regimen, '%m/%d/%Y') AS DATE)
				ELSE NULL
			END AS Start_Date_Of_Regimen
		from omop_staging.sact_staging
	</Sql>
    <Explanations>
	    <Explanation columnName="NHS_Number">
		    <Description>Patient NHS Number</Description>
		    <Origin>NHS NUMBER</Origin>
	    </Explanation>
		<Explanation columnName="Weight_At_Start_Of_Regimen">
			<Description>Weight when the Regimen started</Description>
			<Origin>WEIGHT AT START OF REGIMEN</Origin>
		</Explanation>
		<Explanation columnName="Start_Date_Of_Regimen">
			<Description>Date the Regiment started</Description>
			<Origin>START DATE OF REGIMEN</Origin>
		</Explanation>
	</Explanations>
</Query>
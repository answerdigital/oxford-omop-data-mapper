<Query>
    <Sql>
		with results as (
			select distinct
				(select PatientId from omop_staging.rtds_1_demographics d where d.PatientSer = PatientSer limit 1) as NHSNumber,
				AttributeValue,
				(select concept_id from cdm.concept where domain_id = 'Spec Anatomic Site'
						and concept_code = CASE WHEN length(code) > 3 THEN substr(code, 1, 3) || '.' || substr(code, 4) ELSE code END) as AnatomicalSiteConceptId,
				DueDateTime
			from omop_staging.RTDS_2b_Plan,
			LATERAL (SELECT regexp_extract(AttributeValue, '^([A-Z][0-9A-Z]+)', 1) AS code) AS t
			where Description = 'Anatomical Site' 
			and AttributeValue is not null 
			and AttributeValue != 'None'
		)
		select
			NhsNumber,
			AttributeValue,
			AnatomicalSiteConceptId,
			DueDateTime
		from results
		where
			NhsNumber is not null
			and regexp_matches(NhsNumber, '\d{10}');
	</Sql>
	<Explanations>
		<Explanation columnName="NHSNumber">
			<Description>Patient NHS Number</Description>
			<Origin>NHS NUMBER</Origin>
		</Explanation>
		<Explanation columnName="AttributeValue">
			<Description>ANATOMIC SITE OF RADIOTHERAPY PROCEDURE</Description>
		</Explanation>
		<Explanation columnName="AnatomicalSiteConceptId">
			<Description>CONCEPT ID OF ANATOMIC SITE OF RADIOTHERAPY PROCEDURE</Description>
		</Explanation>
		<Explanation columnName="DueDateTime">
			<Description>DATE WHEN RADIOTHERAPY OCCURRED</Description>
		</Explanation>
	</Explanations>
</Query>
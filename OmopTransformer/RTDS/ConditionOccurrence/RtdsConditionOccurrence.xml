<Query>
    <Sql>
with results as (
	select 
		distinct
			(select PatientId from omop_staging.rtds_1_demographics d where d.PatientSer = dc.PatientSer limit 1) as PatientId,
			dc.DiagnosisCode,
			dc.DateStamp as event_start_date,
			dc.DateStamp as event_end_date
	from omop_staging.RTDS_5_Diagnosis_Course dc
	where dc.DiagnosisTableName = 'ICD-10'
)
select
	PatientId,
	DiagnosisCode,
	event_start_date,
	event_end_date
from results
where
    PatientId is not null
    and regexp_matches(patientid, '\d{10}');
	</Sql>
	<Explanations>
		<Explanation columnName="PatientId">
			<Description>Patient NHS Number</Description>
			<Origin>NHS NUMBER</Origin>
		</Explanation>
		<Explanation columnName="DiagnosisCode">
			<Description>ICD10 Diagnosis Code</Description>
			<Origin></Origin>
		</Explanation>
		<Explanation columnName="event_start_date">
			<Description>Appointment Start Time</Description>
			<Origin>TREATMENT START DATE (RADIOTHERAPY TREATMENT EPISODE)</Origin>
		</Explanation>
		<Explanation columnName="event_end_date">
			<Description>Appointment End Time</Description>
		</Explanation>
	</Explanations>
</Query>
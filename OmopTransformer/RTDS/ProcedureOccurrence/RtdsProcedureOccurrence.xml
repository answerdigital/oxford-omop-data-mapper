<Query>
    <Sql>
with records as (
	select
		PatientSer,
		ProcedureCode,
		ActualStartDateTime_s as Start_date,
		ActualEndDateTime_s as End_date
	from omop_staging.rtds_2a_attendances

	union

	select 
		PatientSer,
		ProcedureCode,
		Start_date,
		End_date
	from omop_staging.rtds_2b_plan
), records_with_patient as (
	select
		(select PatientId from omop_staging.rtds_1_demographics d where d.PatientSer = r.PatientSer limit 1) as PatientId,
		r.*
	from records r
)
select distinct
	PatientId,
	ProcedureCode,
	Start_date as event_start_date,
	End_date as event_end_date
from records_with_patient
where PatientId is not null
	and regexp_matches(patientid, '\d{10}');
	</Sql>
	<Explanations>
		<Explanation columnName="PatientId">
			<Description>Patient NHS Number</Description>
			<Origin>NHS NUMBER</Origin>
		</Explanation>
		<Explanation columnName="ProcedureCode">
			<Description>OPCS Procedure Code</Description>
			<Origin></Origin>
		</Explanation>
		<Explanation columnName="event_start_date">
			<Description>Appointment Start Time</Description>
			<Origin>TREATMENT START DATE (RADIOTHERAPY TREATMENT EPISODE)</Origin>
		</Explanation>
		<Explanation columnName="event_end_date">
			<Description>Appointment End Time</Description>
		</Explanation>
	</Explanations>
</Query>